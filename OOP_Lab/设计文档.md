# 设计文档

1. 将源文件读入，并按行分割，保存在 vector 中。

2. 利用正则表达式逐行检测是否有 `#include` 命令。

    如果有，提取 `#include` 的内容。
    如果内容是一个文件名，则在当前目录下读取文件，插入到 `#include` 的位置处，并删除 `#include` 语句。

3. 利用正则表达式逐行匹配。

    建立 map 来储存键值对，使用布尔值 `in_if_clause` 来判断当前是否在 if 从句中，`valid` 来判断当前的语句是否需要忽略。
    
    - 如果是 #define ，则提取 `#define` 的符号和内容，存入 map 中。
    - 如果是 #undef， 则从 map 中删除这一符号。
    - 如果是 #if、#ifdef、#ifndef，则判断条件是否满足，设置相应的布尔值。
    - 如果是 #else 则切换 `valid`。
    - 如果是 #endif 则退出 if 从句，设置 `in_if_clause` 为 false， `valid` 为 true。
    
  （不考虑 if 语句的嵌套）

  如果是普通的语句，且不需要忽略，则进入下一步。
  
4. 判断普通语句中是否有需要处理的宏定义。

    对每个语句，逐字符进行判断。
    使用有限状态机的思想，记录当前位置的内容是在字符串、字符、注释之中还是在一个合法的符号之中。
    如果在字符串、字符、单行注释之中，则无需处理，直接输出。
    如果是一个合法的符号（以字母数字下划线组成且开头不是数字），则不输出，而是储存到一个字符串中。
    当这个符号已经读完整后，判断其是否被预定义过。
    如果预定义过，则用定义的内容代替当前符号进行输出。

# part3 部分

如何处理带一个参数的宏定义？
1. 在检测宏定义的部分，如果检测出是带参数的 #define（如 `#define A(x) x*2`），
则设置符号为 "A("，以便与 "A" 区分。然后提取出参数。
设置内容时，由于用户自定义的参数各种各样，在存储时统一改为 "\_\_parameter\_\_"。
替换参数的过程同样需要考虑字符串、注释等，因此不能直接替换。在这里复用了上一部分第 4 步的实现。

2. 在普通语句中处理的部分。
由于宏定义中，同一个名字的带参数和不带参数的宏也不能被重复定义，因此当得到一个符号，且判断出这个符号不是被预定义过的无参宏定义，
那么需要接着判断下一个字符是不是左括号，并是不是被预定义过的有参宏定义。
如果是被预定义过的有参宏定义，则提取括号中的内容作为实参。
由于实参内部可能也有括号，因此需要利用括号对应的层级关系扫描得到实参，
然后用实参替换"\_\_parameter\_\_"，并将这一部分整体替换为预定义的内容。


