## 说明文档

### 一、数据需求分析

#### 术语定义

1. **工号**：系统所有用户都有独一无二的**工号**，用以区别用户，同时工号作为用户登录系统的用户名。
2. **教师编号**：当用户类型为教师时，**工号**也称为**教师编号**。
3. **培训计划**：公司有课程来对员工进行培训。部门主管负责制定本部门的**培训计划**。 **培训计划**由必修和选修两部分构成，必修和选修课程都从课程列表中选择。 必修课程默认参加， 选修课程由员工自主选择是否参加。 

#### 数据分析

1. 数据来源
   - 助教提供
2. 新增数据
   - 员工工龄、教师邮箱、教师手机号、部门经理手机号、部门经理邮箱。
3. 删除数据（之前设计有，但是未提供）
   - 员工年龄
4. 内部数据
   - 关系表：只在系统内部使用，不向外部暴露
5. 数据约定
   - **密码**：界面输入密码不能含有非法字符，合法字符为数字、字母、下划线；密码长度必须在6-15之间。**密码储存到数据库要加盐**。
   - **邮箱**：邮箱必须是合法邮箱，即满足邮箱基本格式
   - **手机号**：手机号要满足手机号基本格式
   - **时间**：时间（例如考试时间）单位精确到分，如**2016-12-23 09:00**
   - **工龄**：工龄单位精确到年，如 **4** 代表工龄为4年。同时工龄为导出属性
   - **入职时间**：单位精确到年份，例如2016
   - **用户名**：本系统的用户名就是**工号**，用户不可修改。
6. 数据结构修改
   - **加成比例**：加成比例是一个浮点数，存到数据库会有精度问题，比如该存几位。数据存储时和工资计算成整数存储。


#### 数据字典

1. user
   |        数据项名称        |  数据项类型   | 是否为主键 | 是否为外键 | 是否可为空 |         其他说明          |
   | :-----------------: | :------: | :---: | :---: | :---: | :-------------------: |
   |       user_id       | varchar  |   Y   |   N   |   N   |          工号           |
   | encrypted_password  | varchar  |   N   |   N   |   N   |      加密后的用户登录密码       |
   |        type         |   int    |   N   |   N   |   N   | 0-4: CEO/管理员/教师/主管/员工 |
   | remember_created_at | datetime |   N   |   N   |   Y   |      记录用户登录时间信息       |

2. manager
   |     数据项名称     |  数据项类型  | 是否为主键 | 是否为外键 | 是否可为空 |       其他说明       |
   | :-----------: | :-----: | :---: | :---: | :---: | :--------------: |
   |    user_id    | varchar |   Y   |   Y   |   N   |        工号        |
   |     name      | varchar |   N   |   N   |   N   |                  |
   |    gender     | varchar |   N   |   N   |   N   |      仅限男或女       |
   |   location    | varchar |   N   |   N   |   N   |                  |
   |      tel      | varchar |   N   |   N   |   N   |  手机号，需符合数据约定要求   |
   |     email     | varchar |   N   |   N   |   N   |   邮箱，需符合数据约定要求   |
   | department_id |   int   |   N   |   Y   |   N   | 外键，依赖department表 |

3. employee
   |     数据项名称     |  数据项类型  | 是否为主键 | 是否为外键 | 是否可为空 |               其他说明                |
   | :-----------: | :-----: | :---: | :---: | :---: | :-------------------------------: |
   |    user_id    | varchar |   Y   |   Y   |   N   |                工号                 |
   |     name      | varchar |   N   |   N   |   N   |                                   |
   |    gender     | varchar |   N   |   N   |   N   |               仅限男或女               |
   |   location    | varchar |   N   |   N   |   N   |                                   |
   |   join_date   |   int   |   N   |   N   |   N   | 入职时间仅记录年份，所以用int表示，同时导出**工龄**这一属性 |
   |    salary     |   int   |   N   |   N   |   N   |                                   |
   |     bonus     |   int   |   N   |   N   |   N   |          加成，见**数据结构修改**。          |
   | department_id |   int   |   N   |   Y   |   N   |         外键，依赖department表          |

4. teacher
   |  数据项名称  |  数据项类型  | 是否为主键 | 是否为外键 | 是否可为空 |     其他说明      |
   | :-----: | :-----: | :---: | :---: | :---: | :-----------: |
   | user_id | varchar |   Y   |   Y   |   N   |      工号       |
   |  name   | varchar |   N   |   N   |   N   |               |
   | gender  | varchar |   N   |   N   |   N   |     仅限男或女     |
   |   tel   | varchar |   N   |   N   |   N   | 手机号，需符合数据约定要求 |
   |  email  | varchar |   N   |   N   |   N   | 邮箱，需符合数据约定要求  |

5. department

   | 数据项名称 |  数据项类型  | 是否为主键 | 是否为外键 | 是否可为空 | 其他说明 |
   | :---: | :-----: | :---: | :---: | :---: | :--: |
   |  id   |   int   |   Y   |   N   |   N   |  自增  |
   | name  | varchar |   N   |   N   |   N   |      |

6. plan
   |     数据项名称     | 数据项类型 | 是否为主键 | 是否为外键 | 是否可为空 |       其他说明       |
   | :-----------: | :---: | :---: | :---: | :---: | :--------------: |
   |      id       |  int  |   Y   |   N   |   N   |                  |
   | department_id |  int  |   N   |   Y   |   N   | 外键，约束于department |

7. course
   |   数据项名称    |  数据项类型  | 是否为主键 | 是否为外键 | 是否可为空 | 其他说明  |
   | :--------: | :-----: | :---: | :---: | :---: | :---: |
   | course_id  | varchar |   Y   |   N   |   N   |       |
   |    name    | varchar |   N   |   N   |   N   |       |
   | teacher_id | varchar |   N   |   Y   |   N   | 外键，工号 |
   |   hours    |   int   |   N   |   N   |   N   |  课时   |

8. exam
   |   数据项名称    |  数据项类型  | 是否为主键 | 是否为外键 | 是否可为空 |           其他说明           |
   | :--------: | :-----: | :---: | :---: | :---: | :----------------------: |
   | course_id  | varchar |   N   |   N   |   N   |   和type一起构成主键，在逻辑代码中实现   |
   |    type    | varchar |   N   |   N   |   N   |        仅有考试和补考两种         |
   |    date    | varchar |   N   |   N   |   N   |      自定义日期时间格式，精确到分      |
   |    room    | varchar |   N   |   N   |   N   | 不知room用何种方式表示，所以用varchar |
   | grade_time | varchar |   N   |   N   |   Y   |      自定义日期时间格式，精确到分      |

9. choices

   |    数据项名称    |  数据项类型  | 是否为主键 | 是否为外键 | 是否可为空 |                   其他说明                   |
   | :---------: | :-----: | :---: | :---: | :---: | :--------------------------------------: |
   |  course_id  | varchar |   N   |   Y   |   N   |    和employee_id(**工号**)一起构成主键，在逻辑代码中     |
   | employee_id | varchar |   N   |   Y   |   N   |                                          |
   |    grade    |   int   |   N   |   N   |   Y   |                                          |
   | apply_time  | varchar |   N   |   N   |   Y   |          申请补考的时间，自定义日期时间格式，精确到分          |
   |    state    |   int   |   N   |   N   |   N   | 员工在对应课程的状态，0-5：正常通过/补考未申请/已申请/已缴费/已通过/未通过 |

10. course_plans

|   数据项名称   |  数据项类型  | 是否为主键 | 是否为外键 | 是否可为空 |          其他说明           |
| :-------: | :-----: | :---: | :---: | :---: | :---------------------: |
| course_id | varchar |   N   |   Y   |   N   | 和plan_id一起构成主键，在逻辑代码中实现 |
|  plan_id  |   int   |   N   |   Y   |   N   |                         |
|   type    |   int   |   N   |   N   |   N   |      只取0/1 - 必修/选修      |

### 二、生成数据库

1. development.sqlite3:数据库类型是sqlite3, 我们使用[DB Browser for SQLite](http://sqlitebrowser.org/)查看，可以使用该软件或者其他软件。打开后出以上数据表外，还有使用rails框架默认生成的辅助表，可以无视之。
2. development.sql: 内含数据表创建语句。